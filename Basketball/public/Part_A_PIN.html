<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home — MatchM8 Soccer</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div id="hero" data-page="Home"></div>
  <script src="/config.js"></script>
  <script src="/hero.js" defer></script>

  <main class="container">
    <!-- License Status -->
    <div id="licenseBanner" class="panel" style="display:none">
      <div id="licStatus" style="font-weight:700"></div>
      <div id="licDetail" style="color:var(--muted)"></div>
    </div>

    <!-- Login Panel -->
    <div class="panel">
      <h2 style="margin-top:0">Sign in</h2>
      <form id="loginForm" class="center" style="gap:8px; flex-wrap:wrap; align-items:center;">
        <label> Name<br>
          <input id="loginName" class="input" placeholder="Your name (e.g. Vince)" style="min-width:240px" autocomplete="username">
        </label>
        <label> PIN / Admin Password<br>
          <input id="loginPin" class="input" type="password" placeholder="4+ digits (players) · 6+ chars (Admin)" style="min-width:220px" autocomplete="current-password" inputmode="numeric">
        </label>
        <button id="btnLogin" class="btn primary" style="align-self:flex-end" type="submit">Sign in</button>
        <span id="loginMsg" style="margin-left:8px"></span>
      </form>
      <div style="margin-top:8px; color:var(--muted);">
        Forgot your PIN? Ask your league admin to reset it on the Admin page.
      </div>
    </div>

    <!-- load identity helper BEFORE the inline script below -->
    <script src="/js/mm8-ident.js"></script>

    <!-- Self-registration Panel -->
    <div class="panel" id="signupPanel">
      <h2 style="margin-top:0">New here? Create an account</h2>
      <div class="center" style="gap:8px; flex-wrap:wrap; align-items:center;">
        <label> Full name<br>
          <input id="suName" class="input" placeholder="e.g. Alex Smith" style="min-width:240px">
        </label>
        <label> Email (optional)<br>
          <input id="suEmail" class="input" placeholder="name@example.com" style="min-width:260px" autocomplete="email">
        </label>
        <label> Choose a PIN<br>
          <input id="suPin" class="input" type="password" placeholder="4+ digits" style="min-width:200px" inputmode="numeric">
        </label>
        <label> Invite code (if required)<br>
          <input id="suInvite" class="input" placeholder="Invite code" style="min-width:180px">
        </label>
        <button id="btnSignup" class="btn" style="align-self:flex-end">Create account</button>
        <span id="suMsg" style="margin-left:8px"></span>
      </div>
    </div>
  </main>

  <script>
  /* ---------------- tenant helpers ---------------- */
  const qs = new URLSearchParams(location.search);
  const currentTenant = qs.get('t') || localStorage.getItem('tenant') || '';
  if (qs.get('t')) { try { localStorage.setItem('tenant', qs.get('t')); } catch {} }

  function withTenant(url) {
    const u = new URL(url, location.origin);
    const t = qs.get('t') || localStorage.getItem('tenant') || '';
    if (t) u.searchParams.set('t', t);
    return u.toString();
  }

  const TENANT = new URLSearchParams(location.search).get('t') || localStorage.getItem('tenant') || '';
  if (TENANT) localStorage.setItem('tenant', TENANT);

  // tiny helper to keep tenant on navigation
  function navWithTenant(path, extra='') {
    const t = qs.get('t') || localStorage.getItem('tenant') || '';
    const sep = path.includes('?') ? '&' : '?';
    return t ? `${path}${sep}t=${encodeURIComponent(t)}${extra}` : `${path}${extra}`;
  }

  // Helpers
  const $ = (s) => document.querySelector(s);
  function setMsg(el, text, ok){ el.textContent = text || ''; el.style.color = ok ? 'green' : 'crimson'; }

  // License banner (global; ok to pass tenant too)
  (async function initLicense(){
    try{
      const r = await fetch(withTenant('/api/license/status'), { cache:'no-store' });
      if(!r.ok) return;
      const s = await r.json();
      const box = $('#licenseBanner');
      box.style.display = 'block';
      if(s.ok){
        const lic = s.license||{};
        $('#licStatus').textContent = `License OK — ${lic.edition||''} • Players: ${lic.max_players||0}`;
        $('#licDetail').textContent = `Expires: ${lic.expires_utc? new Date(lic.expires_utc).toLocaleDateString(): '—'}`;
      } else {
        $('#licStatus').textContent = 'License INVALID';
        $('#licDetail').textContent = s.reason || '';
      }
    }catch{}
  })();

  // -------- Admin auth helpers (tenant-aware, tolerant of both path styles) --------
  async function adminState(){
    // try /auth/state first, then /state
    let r = await fetch(withTenant('/api/admin/auth/state')).catch(()=>null);
    if (!r || !r.ok) r = await fetch(withTenant('/api/admin/state')).catch(()=>null);
    return r && r.ok ? r.json() : { bootstrap_required:false };
  }
  async function adminBootstrap(new_password){
    // try legacy _bootstrap then bootstrap
    let r = await fetch(withTenant('/api/admin/_bootstrap'), {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ password: new_password, new_password })
    }).catch(()=>null);
    if (!r || !r.ok) {
      r = await fetch(withTenant('/api/admin/bootstrap'), {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ password: new_password, new_password })
      }).catch(()=>null);
    }
    if(!r || !r.ok) {
      let msg = 'bootstrap_failed';
      try { msg = (await r.json()).error || msg; } catch {}
      throw new Error(msg);
    }
  }
  async function adminLogin(password){
    const r = await fetch(withTenant('/api/admin/login'), {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ password })
    });
    const j = await r.json().catch(()=>({}));
    if(r.status === 409 && j.error === 'bootstrap_required') return { bootstrap:true };
    if(!r.ok || !j.ok) throw new Error(j.error || 'admin_login_failed');
    // store whatever token server returns (separate from ADMIN_TOKEN)
    try { localStorage.setItem('admin_session', j.token || ''); } catch {}
    return { ok:true };
  }

  // -------- Login (Admin or Player) --------
  async function doLogin(e){
    e?.preventDefault();
    const name = $('#loginName').value.trim();
    const pin  = $('#loginPin').value.trim();
    const msgEl = $('#loginMsg'); setMsg(msgEl, '');
    const btn = $('#btnLogin'); btn.disabled = true;

    // Admin path (Admin is NOT a player)
    if (/^admin$/i.test(name)) {
      try {
        const st = await adminState();
        if (st.bootstrap_required) {
          if (pin.length < 6) {
            setMsg(msgEl, 'Set an Admin password (≥ 6 chars) and click Sign in again.', false);
            btn.disabled = false; return;
          }
          await adminBootstrap(pin);
        }
        const ok = await adminLogin(pin);
        if (ok) { location.href = navWithTenant('/admin.html'); return; }
      } catch (e) {
        const map = {
          bad_password: 'Wrong Admin password.',
          admin_token_missing: 'Server missing ADMIN_TOKEN in .env.',
          bootstrap_failed: 'Could not set Admin password.',
        };
        setMsg(msgEl, map[e.message] || 'Admin sign-in failed.', false);
      } finally {
        btn.disabled = false;
      }
      return;
    }

    // Player path
    if(!name || pin.length < 4){
      setMsg(msgEl, 'Enter your name and a 4+ digit PIN.', false);
      btn.disabled = false; return;
    }
    try{
      const r = await fetch(withTenant('/api/auth/pin/verify'), {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name, pin })
      });
      const ct = r.headers.get('content-type')||'';
      const j = ct.includes('application/json') ? await r.json() : {};
      if(!r.ok || j.ok === false) throw new Error(j.error || ('HTTP '+r.status));

      // ✅ Remember the signed-in player for later API calls (adds x-player-id automatically)
      try { MM8.ident.remember({ id: j.id || '', name: j.name || name }); } catch {}

      // Keep tenant sticky (optional safeguard)
      if (currentTenant) { try { localStorage.setItem('tenant', currentTenant); } catch {} }

      location.href = navWithTenant('/Part_B_Predictions.html');
    }catch(e){
      const map = {
        'player not found': 'No such player. Check spelling or create an account.',
        'no PIN set': 'No PIN set yet. Ask your admin to set or reset your PIN.',
        'invalid PIN': 'That PIN didn\'t match. Try again.',
        'HTTP 404': 'Sign-in endpoint not found (server routes not mounted).',
      };
      setMsg(msgEl, map[e.message] || 'Sign in failed.', false);
    } finally {
      btn.disabled = false;
    }
  }

  $('#loginForm').addEventListener('submit', doLogin);
  $('#btnLogin').addEventListener('click', doLogin);

  // -------- Signup --------
  async function selfSignup(){
    const name   = $('#suName').value.trim();
    const email  = $('#suEmail').value.trim();
    const pin    = $('#suPin').value.trim();
    const invite = $('#suInvite').value.trim();
    const msgEl  = $('#suMsg'); setMsg(msgEl, '');

    if(!name || pin.length<4) return setMsg(msgEl, 'Enter a name and a 4+ digit PIN.', false);

    try{
      const r = await fetch(withTenant('/api/players/register'), {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name, email, pin, invite_code: invite })
      });
      const j = await r.json();
      if(!r.ok || !j.ok) throw new Error(j.error || 'sign_up_failed');

      // Log in immediately after signup (best effort)
      const v = await fetch(withTenant('/api/auth/pin/verify'), {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name, pin })
      });
      if(v.ok){
        const jj = await v.json().catch(()=>({}));
        try { MM8.ident.remember({ id: jj.id || '', name: jj.name || name }); } catch {}
        setMsg(msgEl, 'Account created! Redirecting…', true);
        setTimeout(()=> location.href = navWithTenant('/Part_B_Predictions.html'), 400);
      } else {
        setMsg(msgEl, 'Account created. Please sign in above.', true);
      }
    }catch(e){
      const map = {
        name_taken: 'That name is already taken.',
        pin_too_short: 'PIN must be at least 4 digits.',
        email_invalid_or_domain: 'Email looks invalid or not allowed.',
        max_players_reached: 'Player limit reached for this license.',
        bad_invite_code: 'Invite code is incorrect.',
        self_signup_disabled: 'Self-registration is currently disabled.',
        license_invalid: 'License not valid yet. Contact the organizer.'
      };
      setMsg(msgEl, map[e.message] || 'Could not create account.', false);
    }
  }
  $('#btnSignup').addEventListener('click', selfSignup);
  $('#suPin').addEventListener('keydown', e=>{ if(e.key==='Enter') selfSignup(); });

  /* ---- Clear "New user" fields when returning to Home ---- */
  (function(){
    function resetSignupFields(){
      const nameEl = $('#suName');
      const pinEl  = $('#suPin');
      if (nameEl) nameEl.value = '';
      if (pinEl)  pinEl.value  = '';
      const msg = $('#suMsg'); if (msg) msg.textContent = '';
    }
    document.addEventListener('DOMContentLoaded', resetSignupFields);
    window.addEventListener('pageshow', resetSignupFields);
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') resetSignupFields();
    });
  })();
  </script>
  <script src="/js/tenant.js"></script>
</body>
</html>

