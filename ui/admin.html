<!doctype html>
<html lang="en">
<head>
  <link rel="icon" href="/favicon.ico">
  <meta charset="utf-8" />
  <title>Admin — Week</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="wrap">
    <div class="row">
      <h1 id="title">Admin — Week <span id="weekTitle">?</span></h1>
      <span id="devBadge" class="pill muted" title="ADMIN_TOKEN required">token required</span>
    </div>

    <div id="topSuccess" class="succ" style="display:none;"></div>
    <div id="topError" class="err" style="display:none;"></div>

    <div class="card">
      <div class="row" style="gap:8px;">
        <label for="week" style="margin-right:6px;">Week:</label>
        <input id="week" type="number" min="1" value="1" style="width:80px;" />
        <button class="btn primary" id="btnLoadPrev">Load Preview</button>
        <button class="btn primary" id="btnCompute">Compute Scores</button>
      </div>
      <div class="row" style="margin-top:10px; gap:8px;">
        <input id="token" type="text" placeholder="your_admin_token_here" style="flex:1;max-width:360px;">
        <button class="btn primary" id="btnUseToken">Use Token</button>
        <span id="tokenStatus" class="muted">Not set</span>
      </div>
    </div>

    <div id="previewCard" class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>Fixtures & Results</strong>
        <span id="previewStatus" class="muted">No preview loaded</span>
      </div>
      <div id="previewEmpty" class="muted" style="margin-top:8px;">No fixtures yet. Import on the right →</div>
      <div id="previewWrap" style="display:none; margin-top:10px;">
        <table class="table" id="resultsTable">
          <thead><tr><th>ID</th><th>Home</th><th>Away</th><th class="right">Home G</th><th class="right">Away G</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row" style="margin-top:10px; justify-content:flex-end;">
          <button id="btnSaveResults" class="btn primary">Save Results</button>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <strong>Import Fixtures</strong>
        <div class="help">CSV headers: <code>id,home,away,kickoff_iso</code></div>
        <div style="margin-top:10px;">
          <input id="fileCsv" type="file" accept=".csv" />
          <div class="row" style="margin-top:8px; gap:8px;">
            <button class="btn primary" id="btnImportCsv">Import CSV</button>
          </div>
        </div>
        <div style="margin-top:14px;">
          <label>Or paste JSON</label>
          <textarea id="jsonBox" placeholder='[{"id":"1","home":"Arsenal","away":"Leeds","kickoff_iso":"2025-08-20T19:00:00Z"}]'></textarea>
          <div class="row" style="margin-top:8px; gap:8px;">
            <button class="btn" id="btnImportJson">Import JSON</button>
            <button class="btn" id="btnQuickSeed">Quick Seed 2 Future Fixtures</button>
          </div>
        </div>
      </div>

      <div class="card">
        <strong>CSV Utilities</strong>
        <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap;">
          <button class="btn primary" id="btnPredsDownload">Download Predictions CSV</button>
          <button class="btn primary" id="btnScoresDownload">Download Season Scores CSV</button>
        </div>
        <div style="margin-top:12px;">
          <label>Upload Predictions CSV</label>
          <textarea id="csvPreds" placeholder='player_id,predictions,submitted_at,email_sent_at\n"abc123","[{\"home\":1,\"away\":0}]",2025-08-01T12:00:00Z,'></textarea>
          <div class="row" style="margin-top:8px; gap:8px;">
            <button class="btn primary" id="btnPredsUpload">Upload Predictions</button>
          </div>
        </div>
        <div style="margin-top:12px;">
          <label>Upload Season Scores CSV</label>
          <textarea id="csvScores" placeholder='player_id,name,total,weeks_played\n"abc123","Vince",12,1'></textarea>
          <div class="row" style="margin-top:8px; gap:8px;">
            <button class="btn" id="btnScoresUpload">Upload Scores</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    /* ----------------- helpers ----------------- */
    const $ = sel => document.querySelector(sel);
    const qs = new URLSearchParams(location.search);
    const weekInput = $('#week');
    const weekTitle = $('#weekTitle');
    const devBadge = $('#devBadge');
    const topError = $('#topError');
    const topSuccess = $('#topSuccess');
    const tokenInput = $('#token');
    const tokenStatus = $('#tokenStatus');

    function showErr(msg) {
      topError.style.display = 'block';
      topError.textContent = msg;
      topSuccess.style.display = 'none';
    }
    function clearErr() {
      topError.style.display = 'none';
      topError.textContent = '';
    }
    function showOk(msg) {
      topSuccess.style.display = 'block';
      topSuccess.textContent = msg;
      setTimeout(() => { topSuccess.style.display = 'none'; }, 2500);
    }

    function getWeek() { return Number(weekInput.value || 1); }
    function setWeekFromQuery() {
      const w = Number(qs.get('week') || 1);
      weekInput.value = w; weekTitle.textContent = w;
    }

    function getToken() { return localStorage.getItem('admin_token') || ''; }
    function setToken(t) {
      if (t) localStorage.setItem('admin_token', t);
      tokenInput.value = t || '';
      tokenStatus.textContent = t ? 'Stored locally' : 'Not set';
    }

    async function apiFetch(url, opts = {}) {
      const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
      const tok = getToken();
      if (tok) headers['x-admin-token'] = tok; // ✅ header-based auth
      const res = await fetch(url, { ...opts, headers });
      if (!res.ok) {
        const text = await res.text().catch(()=> '');
        throw new Error(`${res.status} ${res.statusText} — ${text || 'request failed'}`);
      }
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) return res.json();
      return res.text();
    }

    // Probe with header (prevents noisy 401)
    async function probeDevMode() {
      try {
        await apiFetch('/api/admin/health', { method: 'GET' });
        devBadge.style.display = 'none';
      } catch {
        devBadge.textContent = 'token required';
        devBadge.style.display = 'inline-block';
      }
    }

    /* --------- preview (fixtures + results) --------- */
    const previewEmpty = $('#previewEmpty');
    const previewWrap = $('#previewWrap');
    const previewStatus = $('#previewStatus');
    const resultsTableBody = $('#resultsTable > tbody');

    async function loadPreview() {
      clearErr();
      const week = getWeek();
      weekTitle.textContent = week;

      // Load results (if any)
      try {
        const res = await apiFetch(`/api/admin/results?week=${encodeURIComponent(week)}`, { method: 'GET' });
        const results = (res && res.results) || {};
        await renderResultsEditable(week, results);
        previewStatus.textContent = 'Preview loaded';
      } catch (e) {
        showErr('Network error while loading preview: ' + e.message);
      }
    }

    async function renderResultsEditable(week, resultsMap) {
      // Load fixtures from file (if exists) to show IDs/home/away
      let fixtures = [];
      try {
        const fx = await fetch(`/data/fixtures/season-2025/week-${week}.json`);
        if (fx.ok) fixtures = await fx.json();
      } catch {}

      resultsTableBody.innerHTML = '';
      if (!fixtures.length) {
        previewEmpty.style.display = 'block';
        previewWrap.style.display = 'none';
        return;
      }
      previewEmpty.style.display = 'none';
      previewWrap.style.display = 'block';

      for (const f of fixtures) {
        const tr = document.createElement('tr');
        const r = resultsMap[f.id] || {};
        tr.innerHTML = `
          <td>${f.id}</td>
          <td>${f.home || ''}</td>
          <td>${f.away || ''}</td>
          <td class="right"><input type="number" min="0" step="1" value="${(r.homeGoals ?? '')}" data-id="${f.id}" data-side="home" style="width:80px"></td>
          <td class="right"><input type="number" min="0" step="1" value="${(r.awayGoals ?? '')}" data-id="${f.id}" data-side="away" style="width:80px"></td>
        `;
        resultsTableBody.appendChild(tr);
      }
    }

    async function saveResults() {
      clearErr();
      const week = getWeek();
      const inputs = resultsTableBody.querySelectorAll('input[data-id]');
      const map = {};
      inputs.forEach(inp => {
        const id = String(inp.getAttribute('data-id'));
        const side = inp.getAttribute('data-side'); // 'home' | 'away'
        const v = inp.value === '' ? null : Number(inp.value);
        if (!map[id]) map[id] = { homeGoals: null, awayGoals: null };
        if (side === 'home') map[id].homeGoals = v;
        if (side === 'away') map[id].awayGoals = v;
      });

      const btn = document.getElementById('btnSaveResults');
      btn.disabled = true; btn.textContent = 'Saving…';

      try {
        await apiFetch('/api/admin/results', {
          method: 'POST',
          body: JSON.stringify({ week, results: map })
        });
        previewStatus.textContent = 'Preview loaded • last action: saved';
        showOk('✅ Results saved');
        await loadPreview(); // re-read from disk
      } catch (e) {
        showErr('Failed saving results: ' + e.message);
      } finally {
        btn.disabled = false; btn.textContent = 'Save Results';
      }
    }

    /* ---------------- fixtures import ---------------- */
    async function importFixturesFromCsvText(csvText) {
      const rows = csvText.trim().split(/\r?\n/);
      const headers = rows.shift().split(',').map(s => s.trim());
      const idx = {
        id: headers.indexOf('id'),
        home: headers.indexOf('home'),
        away: headers.indexOf('away'),
        kickoff_iso: headers.indexOf('kickoff_iso'),
      };
      const fixtures = [];
      for (const line of rows) {
        if (!line.trim()) continue;
        const cols = line.split(',').map(s => s.trim());
        fixtures.push({
          id: cols[idx.id],
          home: cols[idx.home],
          away: cols[idx.away],
          kickoff_iso: cols[idx.kickoff_iso],
        });
      }
      return fixtures;
    }

    async function importFixtures(fixtures) {
      clearErr();
      const week = getWeek();
      try {
        await apiFetch('/api/admin/fixtures/import', {
          method: 'POST',
          body: JSON.stringify({ week, fixtures })
        });
        showOk(`✅ Imported ${fixtures.length} fixtures`);
        await loadPreview();
      } catch (e) {
        showErr('Import failed: ' + e.message);
      }
    }

    /* ---------------- CSV utilities ---------------- */
    async function downloadPredictionsCsv() {
      clearErr();
      const week = getWeek();
      try {
        const text = await apiFetch(`/api/admin/predictions/download?week=${encodeURIComponent(week)}`, { method: 'GET' });
        const blob = new Blob([text], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `predictions-week-${week}.csv`; a.click();
        URL.revokeObjectURL(a.href);
      } catch (e) { showErr('Download failed: ' + e.message); }
    }
    async function uploadPredictionsCsv() {
      clearErr();
      const week = getWeek();
      const csv = $('#csvPreds').value;
      try {
        await apiFetch('/api/admin/predictions/upload', {
          method: 'POST',
          body: JSON.stringify({ week, csv })
        });
        showOk('✅ Predictions uploaded');
      } catch (e) { showErr('Upload failed: ' + e.message); }
    }
    async function downloadScoresCsv() {
      clearErr();
      try {
        const text = await apiFetch('/api/admin/scores/download', { method: 'GET' });
        const blob = new Blob([text], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `season-totals.csv`; a.click();
        URL.revokeObjectURL(a.href);
      } catch (e) { showErr('Download failed: ' + e.message); }
    }
    async function uploadScoresCsv() {
      clearErr();
      const csv = $('#csvScores').value;
      try {
        await apiFetch('/api/admin/scores/upload', {
          method: 'POST',
          body: JSON.stringify({ csv })
        });
        showOk('✅ Season scores uploaded');
      } catch (e) { showErr('Upload failed: ' + e.message); }
    }

    /* ---------------- compute scores ---------------- */
    async function computeScores() {
      clearErr();
      const week = getWeek();
      try {
        const r = await fetch(`/api/scores?week=${encodeURIComponent(week)}`);
        if (r.ok) { showOk('✅ Scores computed (see leaderboard)'); return; }
      } catch {}
      try {
        const r2 = await fetch(`/api/scores/compute?week=${encodeURIComponent(week)}`);
        if (r2.ok) { showOk('✅ Scores computed'); return; }
        showErr('Compute endpoint not available.');
      } catch (e) { showErr('Compute failed: ' + e.message); }
    }

    /* ---------------- wire up ---------------- */
    function wireEvents() {
      $('#btnUseToken').addEventListener('click', () => setToken(tokenInput.value.trim()));
      $('#btnLoadPrev').addEventListener('click', loadPreview);
      $('#btnSaveResults').addEventListener('click', saveResults);

      $('#btnImportCsv').addEventListener('click', async () => {
        const f = $('#fileCsv').files[0]; if (!f) return showErr('Choose a CSV file first.');
        const text = await f.text(); const fixtures = await importFixturesFromCsvText(text); await importFixtures(fixtures);
      });
      $('#btnImportJson').addEventListener('click', async () => {
        try {
          const raw = $('#jsonBox').value.trim();
          const fixtures = JSON.parse(raw);
          const arr = Array.isArray(fixtures) ? fixtures : (fixtures.fixtures || []);
          if (!Array.isArray(arr)) throw new Error('JSON must be an array or {fixtures:[...]}.');
          await importFixtures(arr);
        } catch (e) { showErr('Bad JSON: ' + e.message); }
      });
      $('#btnQuickSeed').addEventListener('click', async () => {
        const seed = [
          { id: 'fixture_chelsea_liverpool', home:'Chelsea', away:'Liverpool', kickoff_iso: new Date(Date.now()+ 2*86400000).toISOString() },
          { id: 'fixture_arsenal_spurs',     home:'Arsenal', away:'Spurs',     kickoff_iso: new Date(Date.now()+ 3*86400000).toISOString() },
        ];
        await importFixtures(seed);
      });

      $('#btnPredsDownload').addEventListener('click', downloadPredictionsCsv);
      $('#btnPredsUpload').addEventListener('click', uploadPredictionsCsv);
      $('#btnScoresDownload').addEventListener('click', downloadScoresCsv);
      $('#btnScoresUpload').addEventListener('click', uploadScoresCsv);

      $('#btnCompute').addEventListener('click', computeScores);
    }

    /* ---------------- init ---------------- */
    (async function init() {
      setWeekFromQuery();
      setToken(getToken());
      wireEvents();
      await probeDevMode();
      try { await loadPreview(); } catch {}
    })();
  </script>
</body>
</html>


