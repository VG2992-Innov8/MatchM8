<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MatchM8 — Week Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --border:#ddd; --muted:#666; --ok:#155724; --okbg:#e6f4ea; --err:#9b1c1c; --errbg:#fde8e8; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color:#111; }
    h1 { margin: 0 0 16px; }
    .wrap { display:grid; grid-template-columns: repeat(3, minmax(260px, 1fr)); gap:12px; }
    @media (max-width: 980px) { .wrap { grid-template-columns: repeat(2, minmax(240px, 1fr)); } }
    @media (max-width: 640px) { .wrap { grid-template-columns: 1fr; } }
    .card { border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .muted { color: var(--muted); font-size: 12px; }
    .banner { display:none; margin: 8px 0 16px; padding:10px 12px; border-radius:10px; border:1px solid #b7e1b7; background: var(--okbg); color: var(--ok); }
    .err { display:none; margin: 8px 0 16px; padding:10px 12px; border-radius:10px; border:1px solid #f5b5b5; background: var(--errbg); color: var(--err); }
    select { padding:6px 8px; border:1px solid var(--border); border-radius:8px; min-width:120px; }
    button { padding:9px 14px; border:1px solid var(--border); border-radius:10px; background:#fafafa; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    #msg { margin-left:10px; color:#333; }
    small.lock { color:#a00; margin-left:8px; }
  </style>
</head>
<body>
  <h1>Week <span id="w">?</span> Summary</h1>

  <div id="ok" class="banner"></div>
  <div id="err" class="err"></div>

  <div id="fixtures" class="wrap"></div>

  <div style="margin-top:16px;">
    <button id="save">Save Picks</button>
    <span id="msg" class="muted"></span>
  </div>

  <script>
    // ---------- helpers ----------
    const qs = new URLSearchParams(location.search);
    const week = Number(qs.get('week') || 1);
    document.getElementById('w').textContent = week;

    function fmt(dt) {
      const d = new Date(dt);
      return isNaN(d.getTime()) ? '-' : d.toLocaleString();
    }
    function isLocked(dt) {
      const ko = new Date(dt).getTime();
      if (isNaN(ko)) return false;   // no date -> treat as unlocked
      return Date.now() >= ko;
    }
    function showOk(text) {
      const el = document.getElementById('ok');
      el.textContent = text; el.style.display = 'block';
      document.getElementById('err').style.display = 'none';
    }
    function showErr(text) {
      const el = document.getElementById('err');
      el.textContent = text; el.style.display = 'block';
      document.getElementById('ok').style.display = 'none';
    }

    const state = { fixtures: [], my: { picks: {} } };

    // ---------- load ----------
    async function load() {
      try {
        const [fxRaw, meRaw] = await Promise.all([
          fetch(`/api/fixtures?week=${week}`),
          fetch(`/api/predictions/me?week=${week}`)
        ]);

        const fxData = await fxRaw.json().catch(() => []);
        const meData = await meRaw.json().catch(() => ({}));

        // server might return {fixtures:[...]} or just [...]
        state.fixtures = Array.isArray(fxData) ? fxData : (fxData.fixtures || []);
        state.my = meData?.record || { picks: {} };

        if (state.my?.email_sent_at) {
          showOk(`Receipt emailed at ${fmt(state.my.email_sent_at)}.`);
        }

        render();
      } catch (e) {
        showErr('Failed to load fixtures or predictions.');
      }
    }

    // ---------- render ----------
    function render() {
      const root = document.getElementById('fixtures');
      root.innerHTML = '';

      state.fixtures.forEach(fx => {
        const dt = fx.kickoff_iso || fx.kickoff || null;
        const locked = isLocked(dt);

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="row">
            <strong>${fx.home} vs ${fx.away}</strong>
            <small class="muted">${fmt(dt)}</small>
          </div>
          <div class="row" style="margin-top:8px;">
            <label for="sel-${fx.id}" class="muted">Your pick:</label>
            <select id="sel-${fx.id}" ${locked ? 'disabled' : ''} aria-label="Pick for ${fx.home} vs ${fx.away}">
              <option value="">— choose —</option>
              <option value="H">Home</option>
              <option value="D">Draw</option>
              <option value="A">Away</option>
            </select>
            ${locked ? '<small class="lock">Locked</small>' : ''}
          </div>
        `;
        root.appendChild(card);

        const sel = card.querySelector('select');
        // normalise key to string
        const key = String(fx.id);
        sel.value = state.my.picks?.[key] || '';
        sel.addEventListener('change', () => {
          if (!state.my.picks) state.my.picks = {};
          state.my.picks[key] = sel.value;
        });
      });
    }

    // ---------- save ----------
    async function save() {
      const btn = document.getElementById('save');
      const msg = document.getElementById('msg');
      btn.disabled = true; msg.textContent = 'Saving…';

      try {
        const body = JSON.stringify({ picks: state.my.picks || {} });
        const res = await fetch(`/api/predictions?week=${week}`, {
          method: 'POST',
          headers: {
            'content-type': 'application/json'
            // Dev helper if you don't want to set a cookie:
            // ,'x-player-id': '1'
          },
          body
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.ok) {
          const hint = (data && (data.error || data.message)) || 'Unknown error';
          msg.textContent = 'Save failed.';
          showErr(`Save failed: ${hint}. If it says "week and auth required", set the cookie: document.cookie = "mm8_pid=1; path=/"`);
          btn.disabled = false;
          return;
        }

        const accepted = Object.keys(data.accepted || {}).length;
        const rejected = Object.keys(data.rejected || {}).length;
        msg.textContent = `Saved. Accepted: ${accepted}, Rejected: ${rejected}${data.email_enqueued ? ' (receipt emailed)' : ''}.`;

        // soft reload so banner updates with email_sent_at
        setTimeout(load, 600);
      } catch (e) {
        msg.textContent = 'Save failed.';
        showErr('Network error while saving.');
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById('save').addEventListener('click', save);
    load();
  </script>
</body>
</html>
