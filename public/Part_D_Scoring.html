<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Scoring — MatchM8</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div id="hero" data-page="Scoring"></div>
  <script src="/hero.js" defer></script>

  <main class="container narrow">
    <div class="panel center">
      <label for="week" class="visually-hidden">Week</label>
      <input id="week" class="input" type="number" min="1" value="1" style="max-width:120px">
      <button id="preview" class="btn">Preview</button>
      <button id="compute" class="btn primary">Calculate & Save</button>
      <a id="toSeason" class="btn" href="/Part_E_Season.html">Season Leaderboard</a>
    </div>

    <div id="ok" class="banner ok" style="display:none">✅ Done.</div>
    <div id="tableWrap" class="panel" style="display:none">
      <table class="table" id="scoresTbl">
        <thead><tr><th>Player</th><th>Week Points</th><th>Season Total</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
  const qs = new URLSearchParams(location.search);
  const weekInput = document.getElementById('week');
  weekInput.value = Number(qs.get('week')) || 1;

  function setSeasonLink(){ document.getElementById('toSeason').href = '/Part_E_Season.html'; }
  setSeasonLink();

  function normalizeWeekly(data){
    // Expected: [{player_id,name,points}] — fallback to empty
    if (Array.isArray(data)) return data.map(r=>({ name:r.name||'Player', week:r.points||0, total: r.total ?? '' }));
    if (data && Array.isArray(data.week)) return data.week.map(r=>({ name:r.name, week:r.points, total:r.total ?? '' }));
    return [];
  }

  async function showTable(rows){
    // merge season totals if present
    try{
      const res = await fetch('/data/scores/season-totals.json', {cache:'no-store'});
      if (res.ok){
        const totals = await res.json(); // { playerId: { name, total } }
        rows = rows.map(r=>{
          const t = Object.values(totals).find(x=>x.name===r.name);
          return {...r, total: t ? t.total : (r.total ?? '')};
        });
      }
    }catch{}
    const tbody = document.querySelector('#scoresTbl tbody');
    tbody.innerHTML = rows.map(r=>`<tr><td>${r.name}</td><td>${r.week ?? ''}</td><td>${r.total ?? ''}</td></tr>`).join('');
    document.getElementById('tableWrap').style.display = 'block';
  }

  async function preview(){
    const w = Number(weekInput.value)||1;
    let rows = [];
    try{
      let res = await fetch(`/api/scores/summary?week=${w}`, {cache:'no-store'});
      if (!res.ok) res = await fetch(`/api/scores?week=${w}`, {cache:'no-store'});
      const data = await res.json();
      rows = normalizeWeekly(data);
    }catch(e){ console.warn('Preview fallback', e); }
    await showTable(rows);
  }

  async function compute(){
    const w = Number(weekInput.value)||1;
    let res;
    try{
      res = await fetch(`/api/scores/calc?week=${w}`, {cache:'no-store'});
      if (!res.ok) res = await fetch(`/api/scores/compute?week=${w}`, {cache:'no-store'});
      const data = await res.json();
      await showTable(normalizeWeekly(data));
      const ok = document.getElementById('ok'); ok.style.display='block'; setTimeout(()=>ok.style.display='none',1500);
    }catch(e){ console.error(e); }
  }

  document.getElementById('preview').addEventListener('click', preview);
  document.getElementById('compute').addEventListener('click', compute);
  </script>
</body>
</html>
