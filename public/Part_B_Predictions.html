<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Predictions — MatchM8</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div id="hero" data-page="Predictions"></div>
  <script src="/hero.js" defer></script>

  <main class="container wide">
    <h2 id="weekLabel" class="subhead"></h2>

    <div class="panel">
      <div class="center">
        <label for="week" class="visually-hidden">Week</label>
        <input id="week" class="input" type="number" min="1" value="1" style="max-width:120px">
        <button id="load" class="btn">Load Fixtures</button>
        <button id="save" class="btn primary">Save Predictions</button>
        <a id="toScoring" class="btn" href="/Part_D_Scoring.html">Go to Scoring</a>
      </div>
      <div id="banner" class="banner ok" style="display:none;margin-top:12px;">✅ Saved locally.</div>
    </div>

    <div id="matches"></div>
  </main>

  <script>
  // ---------- setup ----------
  const qs = new URLSearchParams(location.search);
  const weekInput  = document.getElementById('week');
  const weekLabel  = document.getElementById('weekLabel');
  const toScoring  = document.getElementById('toScoring');

  let TOTAL_WEEKS = 38;  // fallback until /api/config returns

  function setScoringLink(){
    const w = Number(weekInput.value) || 1;
    toScoring.href = `/Part_D_Scoring.html?week=${w}`;
  }

  function updateWeekLabel(){
    const w = Number(weekInput.value) || 1;
    weekLabel.textContent = `Week ${w} of ${TOTAL_WEEKS}`;
    setScoringLink();
  }

  async function initWeekAndTotals(){
    // Prefer /api/config, fall back to URL ?week or 1
    const urlWeek = Number(qs.get('week'));
    try {
      const res = await fetch('/api/config');
      if (!res.ok) throw 0;
      const cfg = await res.json();
      TOTAL_WEEKS = cfg.total_weeks || 38;
      weekInput.value = Number.isFinite(urlWeek) ? urlWeek : (cfg.current_week || 1);
    } catch {
      weekInput.value = Number.isFinite(urlWeek) ? urlWeek : 1;
      TOTAL_WEEKS = TOTAL_WEEKS || 38;
    }
    updateWeekLabel();
  }

  // ---------- data / render ----------
  async function fetchFixtures(week){
    try{
      const res = await fetch(`/api/fixtures?week=${week}`);
      if(!res.ok) throw new Error('bad status '+res.status);
      const data = await res.json();
      // accept either an array or {fixtures:[...]}
      const list = Array.isArray(data) ? data : (Array.isArray(data.fixtures) ? data.fixtures : []);
      if (!Array.isArray(list)) throw new Error('fixtures not array');
      return list;
    }catch(e){
      console.warn('Using fallback fixtures (dev):', e.message);
      return [
        { id:'fixture_1', home:'Arsenal',  away:'Leeds' },
        { id:'fixture_2', home:'Chelsea',  away:'Liverpool' },
        { id:'fixture_3', home:'Spurs',    away:'Everton' },
      ];
    }
  }

  function render(fixtures){
    const root = document.getElementById('matches');
    root.innerHTML = '';
    fixtures.forEach((fx, i) => {
      const row = document.createElement('div');
      row.className = 'match';
      row.innerHTML = `
        <div class="line" data-id="${fx.id}">
          <div class="no">${i+1}</div>
          <div class="team">${fx.home}</div>
          <input class="pred" type="number" min="0" inputmode="numeric" aria-label="${fx.home} goals">
          <span class="sep">–</span>
          <input class="pred" type="number" min="0" inputmode="numeric" aria-label="${fx.away} goals">
          <div class="team">${fx.away}</div>
        </div>`;
      root.appendChild(row);
    });
  }

  async function load(){
    const week = Number(weekInput.value)||1;
    updateWeekLabel(); // keep label in sync when loading
    const fixtures = await fetchFixtures(week);
    render(fixtures);

    // restore local predictions (dev convenience)
    const key = `preds_week_${week}`;
    const saved = JSON.parse(localStorage.getItem(key) || '[]');
    saved.forEach(p=>{
      const line = document.querySelector(`.line[data-id="${p.id}"]`);
      if(!line) return;
      const [h,a]=line.querySelectorAll('input.pred');
      h.value = p.home ?? '';
      a.value = p.away ?? '';
    });
  }

  async function save(){
    const week = Number(weekInput.value)||1;
    const lines = document.querySelectorAll('.line');
    const predictions = Array.from(lines).map(line=>{
      const [h,a]=line.querySelectorAll('input.pred');
      return { id: line.dataset.id, home: h.value===''?null:Number(h.value), away: a.value===''?null:Number(a.value) };
    });

    // 1) Save locally (always)
    localStorage.setItem(`preds_week_${week}`, JSON.stringify(predictions));

    // 2) Try POST to backend if available
    try{
      await fetch('/api/predictions', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ week, predictions })
      });
    }catch(e){ console.warn('Predictions POST skipped/failure (dev)', e); }

    const b = document.getElementById('banner');
    b.style.display='block'; setTimeout(()=>b.style.display='none',1400);
  }

  // ---------- events ----------
  document.getElementById('load').addEventListener('click', load);
  document.getElementById('save').addEventListener('click', save);
  weekInput.addEventListener('input', updateWeekLabel);

  // ---------- boot ----------
  initWeekAndTotals().then(load);
  </script>
</body>
</html>
