<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — MatchM8</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div id="hero" data-page="Admin"></div>
  <script src="/hero.js" defer></script>

  <main class="container wide">
    <!-- Top controls -->
    <div class="panel">
      <div class="center" style="gap:8px;flex-wrap:wrap">
        <label>Week
          <input id="week" class="input" type="number" min="1" value="1" style="max-width:120px">
        </label>
        <button id="btnPreview" class="btn">Load Preview</button>
        <button id="btnCompute" class="btn primary">Compute Scores</button>
        <a class="btn" href="/Part_D_Scoring.html">Scoring</a>
        <a class="btn" href="/Part_E_Season.html">Leaderboard</a>
      </div>

      <!-- token box -->
      <div class="center" style="gap:8px;margin-top:10px;flex-wrap:wrap">
        <input id="adminToken" class="input" placeholder="x-admin-token (from .env)" style="min-width:320px">
        <button id="btnUseToken" class="btn">Use Token</button>
        <span id="tokMsg" class="muted"></span>
      </div>

      <div id="ok" class="banner ok" style="display:none;margin-top:10px"></div>
      <div id="err" class="banner error" style="display:none;margin-top:10px"></div>
    </div>

    <!-- Results upsert -->
    <div class="panel">
      <h3 style="margin:0 0 8px">Upsert a Result</h3>
      <div class="center" style="gap:8px;flex-wrap:wrap">
        <input id="matchId" class="input" placeholder="match id (e.g. EPL-2025-W1-M1)" style="min-width:260px">
        <input id="homeScore" class="input" type="number" min="0" placeholder="home" style="width:90px">
        <span>–</span>
        <input id="awayScore" class="input" type="number" min="0" placeholder="away" style="width:90px">
        <button id="btnUpsert" class="btn">Save Result</button>
      </div>
      <div class="muted" style="margin-top:8px">
        Requires a valid admin token; saved under the current tenant folder.
      </div>
    </div>

    <!-- Preview table -->
    <div class="panel">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>Player</th>
            <th class="right">Week Points</th>
            <th class="right">Season Total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="empty" class="muted" style="padding:8px;display:none">No scores yet.</div>
    </div>
  </main>

  <script>
  const $ = s => document.querySelector(s);
  const weekInput = $('#week');
  const ok = $('#ok');
  const err = $('#err');
  const tbody = $('#tbl tbody');
  const empty = $('#empty');
  const tokMsg = $('#tokMsg');

  // ----- tenant + token helpers -----
  function withTenant(url){
    const u = new URL(url, location.origin);
    const t = new URLSearchParams(location.search).get('t') || localStorage.getItem('tenant') || '';
    if (t) u.searchParams.set('t', t);
    return u.toString();
  }
  const TENANT = new URLSearchParams(location.search).get('t') || localStorage.getItem('tenant') || '';
  if (TENANT) try { localStorage.setItem('tenant', TENANT) } catch {}

  function getAdminToken(){ try { return localStorage.getItem('admin_token') || '' } catch { return '' } }
  function setAdminToken(t){ try { localStorage.setItem('admin_token', t || '') } catch {} }
  function adminHeaders(){
    const h = {};
    const tok = getAdminToken();
    if (tok) h['x-admin-token'] = tok;
    const t = TENANT || '';
    if (t) h['x-tenant'] = t;
    return h;
  }
  function showTokState(){
    const tok = getAdminToken();
    tokMsg.textContent = tok ? 'Stored locally ✓' : '';
    $('#adminToken').value = tok || '';
  }
  showTokState();

  // ----- config -----
  let TOTAL_WEEKS = 38;
  async function loadConfig(){
    try{
      const cfg = await fetch(withTenant('/api/config'), {cache:'no-store'}).then(r=>r.json());
      TOTAL_WEEKS = Number(cfg.total_weeks||38);
      const startW = Number(new URLSearchParams(location.search).get('week')) || Number(cfg.current_week||1);
      weekInput.value = Math.max(1, Math.min(TOTAL_WEEKS, startW));
    }catch{}
  }

  function bannerOK(m){ ok.textContent = m || 'OK'; ok.style.display='block'; err.style.display='none'; setTimeout(()=> ok.style.display='none', 1600); }
  function bannerERR(m){ err.textContent = m || 'Failed'; err.style.display='block'; ok.style.display='none'; }

  // ----- preview + compute (no admin required) -----
  function rowsFromSummary(payload){
    if (!payload) return [];
    const weekly = Array.isArray(payload.weekly) ? payload.weekly : [];
    const totalsArr = Array.isArray(payload.seasonTotals) ? payload.seasonTotals : [];
    const totalsMap = new Map(totalsArr.map(t => [String(t.player_id), Number(t.totalPoints ?? t.total ?? 0)]));
    return weekly.map(r => ({
      name: (r.player ?? r.name ?? '').trim(),
      week: Number(r.weekPoints ?? r.week_points ?? 0),
      total: totalsMap.get(String(r.player_id)) ?? Number(r.seasonTotal ?? 0)
    }));
  }
  function renderRows(rows){
    tbody.innerHTML = '';
    if (!rows.length) { empty.style.display='block'; return; }
    empty.style.display='none';
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.name || ''}</td>
        <td class="right">${Number.isFinite(+r.week) ? +r.week : ''}</td>
        <td class="right">${Number.isFinite(+r.total) ? +r.total : ''}</td>`;
      tbody.appendChild(tr);
    });
  }
  async function preview(){
    const w = Math.max(1, Math.min(TOTAL_WEEKS, Number(weekInput.value)||1));
    try{
      const r = await fetch(withTenant(`/api/scores/summary?week=${encodeURIComponent(w)}`), {cache:'no-store'});
      const data = r.ok ? await r.json().catch(()=>({})) : {};
      const rows = rowsFromSummary(data);
      renderRows(rows);
      if (!rows.length) empty.textContent = 'No scores yet. Enter some results, then Compute.';
    }catch(e){
      bannerERR('Preview failed: ' + e.message);
    }
  }
  async function compute(){
    const w = Math.max(1, Math.min(TOTAL_WEEKS, Number(weekInput.value)||1));
    try{
      // prefer POST ?week=… then fallback body
      let resp = await fetch(withTenant(`/api/scores/compute?week=${encodeURIComponent(w)}`), { method:'POST' }).catch(()=>null);
      if (!resp || !resp.ok) {
        resp = await fetch(withTenant('/api/scores/compute'), {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ week: w })
        }).catch(()=>null);
      }
      if (!resp || !resp.ok) throw new Error(resp ? `${resp.status}` : 'network');
      bannerOK(`Computed week ${w}`);
      await preview();
    }catch(e){
      bannerERR('Compute failed: ' + e.message);
    }
  }

  // ----- result upsert (admin token required) -----
  async function upsertResult(){
    const match_id = $('#matchId').value.trim();
    const home = Number($('#homeScore').value);
    const away = Number($('#awayScore').value);
    if (!match_id) { bannerERR('Enter a match id'); return; }
    const headers = { 'Content-Type':'application/json', ...adminHeaders() };
    if (!headers['x-admin-token']) { bannerERR('Admin token required. Paste it above and click Use Token.'); return; }
    try{
      const r = await fetch(withTenant('/api/results/upsert'), {
        method:'PUT',
        headers,
        body: JSON.stringify({ match_id, home_score: home, away_score: away })
      });
      const j = await r.json().catch(()=>({}));
      if (!r.ok || !j.ok) throw new Error(j.error || 'upsert_failed');
      bannerOK('Result saved');
      await preview();
    }catch(e){
      bannerERR(String(e.message || e));
    }
  }

  // ----- wires -----
  $('#btnUseToken').addEventListener('click', () => {
    const v = $('#adminToken').value.trim();
    setAdminToken(v);
    showTokState();
  });
  $('#btnPreview').addEventListener('click', preview);
  $('#btnCompute').addEventListener('click', compute);
  $('#btnUpsert').addEventListener('click', upsertResult);
  weekInput.addEventListener('change', preview);

  (async () => { await loadConfig(); await preview(); })();
  </script>
</body>
</html>
