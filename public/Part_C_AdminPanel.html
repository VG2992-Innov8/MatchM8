<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MatchM8 – Admin Panel</title>
  
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="title-bar">MatchM8 Soccer Predictions</div>
  <div class="league-bar">English Premier League</div>
  <div class="subtitle-bar" id="admin-subtitle">Admin Panel – Week ?</div>

  <div class="admin-section" id="fixture-list">
    Loading fixtures...
  </div>

  <button class="btn matchm8-button primary" onclick="saveResults()">Save Results</button>

  <script>
    const params = new URLSearchParams(window.location.search);
    const week = params.get("week") || "1";
    document.getElementById("admin-subtitle").textContent = `Admin Panel – Week ${week}`;

    const fixtureContainer = document.getElementById("fixture-list");

    // Step 1: Authenticate or reuse token
    async function authenticateAdmin() {
      let token = localStorage.getItem("ADMIN_TOKEN");

      if (!token) {
        const password = prompt("Enter admin password:");
        if (!password) return;

        const res = await fetch("/api/auth/token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });

        if (!res.ok) {
          alert("❌ Incorrect password.");
          return location.reload();
        }

        const data = await res.json();
        token = data.token;
        localStorage.setItem("ADMIN_TOKEN", token);
      }

      const valid = await validateToken(token);
      if (!valid) {
        localStorage.removeItem("ADMIN_TOKEN");
        return authenticateAdmin(); // Retry once
      }

      loadFixtures();
    }

    async function validateToken(token) {
      const res = await fetch("/api/auth/token/verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token })
      });
      return res.ok;
    }

    function loadFixtures() {
      fetch(`/data/fixtures/season-2025/week-${week}.json`)
        .then(res => {
          if (!res.ok) throw new Error("Fixture file not found.");
          return res.json();
        })
        .then(fixtures => {
          fixtureContainer.innerHTML = "";
          fixtures.forEach(fixture => {
            const row = document.createElement("div");
            row.className = "fixture-row";
            row.innerHTML = `
              <span>${fixture.home_team}</span>
              <input type="number" min="0" max="10" class="score-input result-input" data-match="${fixture.id}" data-side="home" />
              <span>vs</span>
              <input type="number" min="0" max="10" class="score-input result-input" data-match="${fixture.id}" data-side="away" />
              <span>${fixture.away_team}</span>
            `;
            fixtureContainer.appendChild(row);
          });
        })
        .catch(err => {
          fixtureContainer.innerHTML = `<p style="color:red;">Error loading fixtures: ${err.message}</p>`;
        });
    }

    function saveResults() {
      const resultInputs = document.querySelectorAll('.result-input');
      const results = {};

      resultInputs.forEach(input => {
        const matchId = input.dataset.match;
        const side = input.dataset.side;

        if (!results[matchId]) {
          results[matchId] = { home: 0, away: 0 };
        }

        if (side === 'home') {
          results[matchId].home = parseInt(input.value) || 0;
        } else {
          results[matchId].away = parseInt(input.value) || 0;
        }
      });

      const token = localStorage.getItem('ADMIN_TOKEN');

      fetch(`/api/admin/save-results?week=${week}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': token
        },
        body: JSON.stringify(results)
      })
      .then(res => {
        if (!res.ok) throw new Error('Save failed');
        return res.json();
      })
      .then(data => {
        alert('✅ Results saved successfully!');
      })
      .catch(err => {
        console.error('❌ Error saving results:', err);
        alert('❌ Failed to save results. Check the console.');
      });
    }

    authenticateAdmin();
  </script>
</body>
</html>


